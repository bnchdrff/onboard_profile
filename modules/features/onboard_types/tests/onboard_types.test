<?php

class OnboardTypesPermissionsTestCase extends DrupalWebTestCase {
  protected $city1;
  protected $city2;
  protected $admin;
  protected $clerk1;
  protected $clerk2;

  public static function getInfo() {
    return array(
      'name' => 'Onboard Types Permissions',
      'description' => 'Ensure that permissions for Cities, Board, Board Terms and People function properly',
      'group' => 'Onboard',
    );
  }

  public function drupalCreateUserWithRole($role, array $permissions = array()) {
    $roles = user_roles();
    $index = array_search($role, $roles);
    $user = $this->drupalCreateUser($permissions);
    $user->roles[$index] = $role;
    return user_save($user);
  }

  public function createCity($name) {
    debug(taxonomy_vocabulary_get_names());
    $city_vocab = taxonomy_vocabulary_machine_name_load('city');
    debug($city_vocab);
    $city = taxonomy_term_save((object) array(
      'vid' => $city_vocab->vid, 
      'name' => $name,
    ));
    debug($city);
    return $city; 
  }

  public function assignClerk($user, $city) {
    $roles = og_roles($city->gid);
    $rid = array_search('clerk', $roles);
    og_group('city', $city, array(
      'entity_type' => 'user',
      'entity' => $user,
    ));
    og_role_grant('ctiy', $city->gid, $user->uid, $rid);
  }

  public function setUp() {
    // Enable modules required for the test.  Dependencies are automatically
    // installed.
    // Will things work better if we use our custom install profile or the 
    // default?  Seems like there's different errors in both cases.
    //$this->profile = 'onboard_profile';
    parent::setUp(array(
      'addressfield',
      'ctools',
      'date',
      'entityreference',
      'features',
      'file',
      'list',
      'node',
      'og',
      'og_field_access',
      'og_ui',
      'options',
      'strongarm',
      'taxonomy',
      'text',
      'onboard_types',
    ));
    debug(module_list(TRUE));
    debug(features_get_features());

    $this->admin = $this->drupalCreateUserWithRole('administrator');
    $this->clerk1 = $this->drupalCreateUserWithRole('clerk');
    $this->clerk2 = $this->drupalCreateUserWithRole('clerk');

    $this->city1 = $this->createCity("Ferndale");
    //$this->city2 = $this->createCity("Ypsilanti", $this->admin);

    // Associate the clerks with the cities
    //$this->assignClerk($this->clerk1, $this->city1);
    //$this->assignClerk($this->clerk2, $this->city2);
  }

  public function testCreateBoard() {
    $this->drupalLogin($this->clerk1);
    $edit = array();
    $edit['title'] = "Board 1"; 
    $edit["city[und][0][target_id]"] = $this->city1;
    $this->drupalPost('node/add/board', $edit, t('Save'));
    $this->assertText(t('Board @title has been created.', array('@title' => $edit['title'])));
  }
}
